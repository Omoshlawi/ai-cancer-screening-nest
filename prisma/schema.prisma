generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String                   @id
  name                    String
  email                   String                   @unique
  emailVerified           Boolean                  @default(false)
  image                   String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @default(now()) @updatedAt
  username                String?                  @unique
  displayUsername         String?
  role                    String?
  banned                  Boolean?                 @default(false)
  banReason               String?
  banExpires              DateTime?
  twoFactorEnabled        Boolean?                 @default(false)
  phoneNumber             String?                  @unique
  phoneNumberVerified     Boolean?
  accounts                Account[]
  communityHealthProvider CommunityHealthProvider?
  sessions                Session[]
  twofactors              TwoFactor[]
  activities              UserActivity[]

  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?
  userAgent      String?
  userId         String
  impersonatedBy String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Jwks {
  id         String   @id
  publicKey  String
  privateKey String
  createdAt  DateTime

  @@map("jwks")
}

model CommunityHealthProvider {
  id          String      @id @default(cuid())
  userId      String      @unique
  firstName   String
  lastName    String
  phoneNumber String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  clients     Client[]
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  followUps   FollowUp[]
  screenings  Screening[]

  @@map("community_health_providers")
}

model Client {
  id            String                  @id @default(cuid())
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  phoneNumber   String
  county        String
  subcounty     String
  ward          String
  nationalId    String
  maritalStatus MaritalStatus
  createdById   String
  metadata      Json?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  createdBy     CommunityHealthProvider @relation(fields: [createdById], references: [id], onDelete: Cascade)
  followUps     FollowUp[]
  screenings    Screening[]

  @@map("clients")
}

model Screening {
  id                                      String                  @id @default(cuid())
  clientId                                String
  providerId                              String
  coordinates                             Json
  lifeTimePatners                         Int
  firstIntercourseAge                     Int
  everDiagnosedWithHIV                    ScreenBoolean
  everDiagnosedWithHPV                    ScreenBoolean
  everDiagnosedWithSTI                    ScreenBoolean
  totalBirths                             Int
  everScreenedForCervicalCancer           ScreenBoolean
  usedOralContraceptivesForMoreThan5Years ScreenBoolean
  smoking                                 SmokingStatus
  familyMemberDiagnosedWithCervicalCancer ScreenBoolean
  scoringResult                           Json?
  nextScreeningDate                       DateTime?
  createdAt                               DateTime                @default(now())
  updatedAt                               DateTime                @updatedAt
  wasTriggeredBy                          FollowUp?               @relation("ResolvingScreening")
  triggeredFollowUps                      FollowUp[]              @relation("TriggeringScreening")
  referrals                               Referral[]
  client                                  Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider                                CommunityHealthProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("screenings")
}

model HealthFacilityType {
  id               String           @id @default(uuid())
  name             String
  description      String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  healthFacilities HealthFacility[]

  @@map("health_facility_types")
}

model HealthFacility {
  id          String             @id @default(uuid())
  kmflCode    String             @unique
  name        String
  address     String?
  county      String
  subcounty   String
  ward        String?
  phoneNumber String?
  email       String?
  logo        String?
  coordinates Json?
  owner       String?
  typeId      String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  type        HealthFacilityType @relation(fields: [typeId], references: [id], onDelete: Cascade)
  referrals   Referral[]

  @@map("health_facilities")
}

model FaqTopic {
  id        String                    @id @default(cuid())
  name      String
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt
  faqs      FrequentlyAskedQuestion[]

  @@map("faq_topics")
}

model FrequentlyAskedQuestion {
  id        String    @id @default(cuid())
  question  String
  answer    String
  topicId   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  topic     FaqTopic? @relation(fields: [topicId], references: [id])

  @@map("frequently_asked_questions")
}

model UserActivity {
  id          String   @id @default(cuid())
  userId      String
  action      String
  resource    String
  resourceId  String?
  metadata    Json?
  description String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@map("user_activities")
}

model TwoFactor {
  id          String @id
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model AddressHierarchy {
  id        String             @id @default(uuid())
  country   String
  level     Int
  parentId  String?
  code      String
  name      String
  nameLocal String?
  voided    Boolean            @default(false)
  parent    AddressHierarchy?  @relation("Hierarchy", fields: [parentId], references: [id])
  children  AddressHierarchy[] @relation("Hierarchy")

  @@unique([country, code])
  @@index([country, level])
  @@index([parentId])
  @@map("address_heirarchy")
}

model Referral {
  id               String         @id @default(cuid())
  screeningId      String
  healthFacilityId String
  appointmentTime  DateTime
  additionalNotes  String?
  transportNeeded  Boolean        @default(false)
  financialSupport Boolean        @default(false)
  status           ReferralStatus @default(PENDING)
  visitedDate      DateTime?
  testResult       TestOutcome?
  finalDiagnosis   String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  followUp         FollowUp?
  healthFacility   HealthFacility @relation(fields: [healthFacilityId], references: [id], onDelete: Cascade)
  screening        Screening      @relation(fields: [screeningId], references: [id], onDelete: Cascade)

  @@map("referrals")
}

model FollowUp {
  id                   String                  @id @default(cuid())
  clientId             String
  providerId           String
  referralId           String?                 @unique
  triggerScreeningId   String
  category             FollowUpCategory
  priority             Priority                @default(MEDIUM)
  startDate            DateTime                @default(now())
  dueDate              DateTime
  completedAt          DateTime?
  outcomeNotes         String?
  resolvingScreeningId String?                 @unique
  cancelReason         CancelReason?
  cancelNotes          String?
  canceledAt           DateTime?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  client               Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider             CommunityHealthProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  referral             Referral?               @relation(fields: [referralId], references: [id], onDelete: Cascade)
  resolvingScreening   Screening?              @relation("ResolvingScreening", fields: [resolvingScreeningId], references: [id])
  triggerScreening     Screening               @relation("TriggeringScreening", fields: [triggerScreeningId], references: [id])
  outreachActions      OutreachAction[]

  @@index([referralId])
  @@index([providerId])
  @@index([clientId])
  @@map("follow_ups")
}

model OutreachAction {
  id                    String          @id @default(cuid())
  followUpId            String
  actionType            OutreachType
  actionDate            DateTime
  outcome               OutreachOutcome
  location              String?
  duration              Int?
  notes                 String?
  barriers              String?
  nextPlannedDate       DateTime?
  hospitalRegisterPhoto String?
  createdAt             DateTime        @default(now())
  followUp              FollowUp        @relation(fields: [followUpId], references: [id], onDelete: Cascade)

  @@index([followUpId])
  @@index([actionDate])
  @@map("outreach_actions")
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  SEPARATED
}

enum ScreenBoolean {
  YES
  NO
  NOT_SURE
}

enum SmokingStatus {
  CURRENTLY
  NEVER
  PAST
}

enum TestOutcome {
  POSITIVE
  NEGATIVE
}

enum OutreachType {
  PHONE_CALL
  HOME_VISIT
  SMS_SENT
  FACILITY_VERIFICATION
}

enum OutreachOutcome {
  PATIENT_UNAVAILABLE
  PATIENT_COMMITTED
  PATIENT_VISITED_FACILITY
  PATIENT_REFUSED
  BARRIER_IDENTIFIED
  LOST_CONTACT
}

enum ReferralStatus {
  PENDING
  VISITED_PENDING_RESULTS
  COMPLETED
  REFUSED
}

enum FollowUpCategory {
  REFERRAL_ADHERENCE
  RE_SCREENING_RECALL
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum CancelReason {
  DECEASED
  RELOCATED
  UNREACHABLE
  REFUSED_SERVICE
  INCORRECT_DATA
  HOSPITALIZED_OTHER
}
